apiVersion: batch/v1
kind: Job
metadata:
  name: affine-migrate
  namespace: affine
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 2
  template:
    spec:
      restartPolicy: OnFailure

      # Wait for Postgres to be ready
      initContainers:
        - name: wait-for-postgres
          image: postgres:16
          command: ["/bin/sh","-lc"]
          args:
            - >
              until pg_isready -h postgres -p 5432 -d affine -U affine; do
                echo "Waiting for postgres...";
                sleep 2;
              done
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: affine-db-secret
                  key: password

      containers:
        - name: migrate
          image: ghcr.io/toeverything/affine:stable
          workingDir: /app
          env:
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: affine-db-secret
                  key: password
            - name: DATABASE_URL
              value: postgresql://affine:$(DB_PASSWORD)@postgres:5432/affine
          command: ["/bin/sh","-lc"]
          args:
            - >
              echo "Trying prisma migrate..." &&
              (npx prisma migrate deploy --schema=/app/prisma/schema.prisma ||
               yarn prisma migrate deploy --schema=/app/prisma/schema.prisma ||
               node node_modules/prisma/build/index.js migrate deploy --schema=/app/prisma/schema.prisma)
